<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniCertify - Academic Transcript Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-bottom-width: 2px;
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
        }
        .form-section {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .course-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .course-row input {
            flex-grow: 1;
        }
        .transcript-id-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }
        .transcript-id-button:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-blue-600 text-white p-6 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold">UniCertify</h1>
            <div>
                 <button id="connectWalletBtn" class="bg-white text-blue-600 font-semibold py-2 px-4 rounded hover:bg-gray-100 transition duration-150">
                     Connect Wallet
                 </button>
                 <span id="walletAddress" class="ml-4 text-sm"></span>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-sm">
        <div class="container mx-auto flex justify-center">
            <button id="tab-institution" class="tab-button py-4 px-6 text-gray-600 hover:text-blue-500 focus:outline-none active">
                <i class="fas fa-university mr-2"></i>Institution Portal
            </button>
            <button id="tab-student" class="tab-button py-4 px-6 text-gray-600 hover:text-blue-500 focus:outline-none">
                <i class="fas fa-user-graduate mr-2"></i>Student Portal
            </button>
            <button id="tab-employer" class="tab-button py-4 px-6 text-gray-600 hover:text-blue-500 focus:outline-none">
                <i class="fas fa-briefcase mr-2"></i>Employer Portal
            </button>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        <div id="content-institution" class="form-section">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-600 mb-6">Issue New Academic Transcript</h2>
                <form id="issueTranscriptForm" class="space-y-6">
                    <fieldset class="border p-4 rounded-md">
                        <legend class="text-lg font-medium text-gray-700 px-2">Student Information</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Student Full Name</label>
                                <input type="text" id="studentName" name="studentName" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Jane Doe">
                            </div>
                            <div>
                                <label for="studentId" class="block text-sm font-medium text-gray-700 mb-1">Student ID (from Institution)</label>
                                <input type="text" id="studentId" name="studentId" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., STU12345">
                            </div>
                            <div>
                                <label for="studentEthAddress" class="block text-sm font-medium text-gray-700 mb-1">Student Ethereum Address</label>
                                <input type="text" id="studentEthAddress" name="studentEthAddress" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 0x123...">
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="border p-4 rounded-md">
                        <legend class="text-lg font-medium text-gray-700 px-2">Academic Details</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <label for="issuingInstitution" class="block text-sm font-medium text-gray-700 mb-1">Issuing Institution</label>
                                <input type="text" id="issuingInstitution" name="issuingInstitution" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., City University">
                            </div>
                            <div>
                                <label for="programName" class="block text-sm font-medium text-gray-700 mb-1">Program/Degree Name</label>
                                <input type="text" id="programName" name="programName" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Bachelor of Science">
                            </div>
                            <div>
                                <label for="graduationDate" class="block text-sm font-medium text-gray-700 mb-1">Graduation Date</label>
                                <input type="date" id="graduationDate" name="graduationDate" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="border p-4 rounded-md">
                        <legend class="text-lg font-medium text-gray-700 px-2">Courses & Grades</legend>
                        <div id="coursesContainer" class="mt-4 space-y-3">
                            <div class="course-row">
                                <input type="text" name="courseName[]" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Course Name" required>
                                <input type="text" name="courseGrade[]" class="w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Grade" required>
                                <button type="button" class="removeCourseBtn bg-red-500 hover:bg-red-600 text-white p-2 rounded-md shadow-sm" onclick="removeCourse(this)" disabled>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" id="addCourseBtn" class="mt-4 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md shadow-sm flex items-center">
                            <i class="fas fa-plus mr-2"></i>Add Another Course
                        </button>
                    </fieldset>

                    <div class="flex justify-end mt-8">
                        <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                            Issue Transcript
                        </button>
                    </div>
                </form>
                <div id="messageArea" class="mt-6 p-4 rounded-md" style="display: none;"></div>
            </div>
        </div>

        <div id="content-student" class="form-section" style="display: none;">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-600 mb-6">Student Portal</h2>
                <div id="studentTranscriptListArea" class="mb-6">
                    <p class="text-gray-600">Connect your wallet and click "Load My Transcripts" to see your transcript IDs.</p>
                    <button id="loadMyTranscriptsBtn" class="mt-2 px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md shadow-sm">Load My Transcripts</button>
                    </div>
                <div class="mt-4 p-4 border rounded-md bg-gray-50 text-gray-700 min-h-[100px]" id="studentTranscriptDetailsArea">
                    Select a transcript ID from the list above to view details...
                </div>
            </div>
        </div>

        <div id="content-employer" class="form-section" style="display: none;">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-600 mb-6">Employer/Verification Portal</h2>
                <p class="text-gray-600">Use this portal to verify the authenticity of an academic transcript.</p>
                 <div class="mt-6">
                    <label for="verifyTranscriptId" class="block text-sm font-medium text-gray-700 mb-1">Enter Transcript ID to Verify</label>
                     <div class="flex gap-2">
                        <input type="text" id="verifyTranscriptId" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Transcript ID">
                        <button id="verifyTranscriptBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-sm">Verify</button>
                    </div>
                    <div id="verificationResult" class="mt-4 p-4 border rounded-md bg-gray-50 text-gray-700 min-h-[50px]">
                        Verification status will appear here...
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-gray-300 p-6 mt-12 text-center">
        <p>&copy; <span id="currentYear"></span> UniCertify. All rights reserved.</p>
    </footer>

<script defer>
    // --- Configuration ---
    const contractAddress = "0x82ab09786c7ca3f7e7Fb6107462A291f34b9e67e"; // <-- REPLACE THIS
    const contractAbi = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "AccessControlBadConfirmation",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			},
			{
				"internalType": "bytes32",
				"name": "neededRole",
				"type": "bytes32"
			}
		],
		"name": "AccessControlUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "role",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "previousAdminRole",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "newAdminRole",
				"type": "bytes32"
			}
		],
		"name": "RoleAdminChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "role",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			}
		],
		"name": "RoleGranted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "role",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			}
		],
		"name": "RoleRevoked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "transcriptId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "studentAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "studentId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "issuingInstitution",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "issuer",
				"type": "address"
			}
		],
		"name": "TranscriptIssued",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "DEFAULT_ADMIN_ROLE",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "INSTITUTION_ROLE",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getMyTranscriptIds",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "role",
				"type": "bytes32"
			}
		],
		"name": "getRoleAdmin",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_transcriptId",
				"type": "uint256"
			}
		],
		"name": "getTranscript",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "studentAddress",
						"type": "address"
					},
					{
						"internalType": "string",
						"name": "studentName",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "studentId",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "issuingInstitution",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "programName",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "graduationDate",
						"type": "uint256"
					},
					{
						"components": [
							{
								"internalType": "string",
								"name": "name",
								"type": "string"
							},
							{
								"internalType": "string",
								"name": "grade",
								"type": "string"
							}
						],
						"internalType": "struct UniCertify.Course[]",
						"name": "courses",
						"type": "tuple[]"
					},
					{
						"internalType": "address",
						"name": "issuerAddress",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "issueTimestamp",
						"type": "uint256"
					}
				],
				"internalType": "struct UniCertify.Transcript",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_institutionAccount",
				"type": "address"
			}
		],
		"name": "grantInstitutionRole",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "role",
				"type": "bytes32"
			},
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "grantRole",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "role",
				"type": "bytes32"
			},
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "hasRole",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_studentName",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_studentAddress",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "_studentId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_issuingInstitution",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_programName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_graduationDate",
				"type": "uint256"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "grade",
						"type": "string"
					}
				],
				"internalType": "struct UniCertify.Course[]",
				"name": "_courses",
				"type": "tuple[]"
			}
		],
		"name": "issueTranscript",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_studentName",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_studentAddress",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "_studentId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_issuingInstitution",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_programName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_graduationDate",
				"type": "uint256"
			},
			{
				"internalType": "string[]",
				"name": "courseNames",
				"type": "string[]"
			},
			{
				"internalType": "string[]",
				"name": "courseGrades",
				"type": "string[]"
			}
		],
		"name": "issueTranscriptManual",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "role",
				"type": "bytes32"
			},
			{
				"internalType": "address",
				"name": "callerConfirmation",
				"type": "address"
			}
		],
		"name": "renounceRole",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_institutionAccount",
				"type": "address"
			}
		],
		"name": "revokeInstitutionRole",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "role",
				"type": "bytes32"
			},
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "revokeRole",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes4",
				"name": "interfaceId",
				"type": "bytes4"
			}
		],
		"name": "supportsInterface",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    // --- Ethers.js Setup ---
    let provider;
    let signer;
    let contract;
    let userAddress = null;

    // --- DOM Elements ---
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const walletAddressSpan = document.getElementById('walletAddress');
    const issueTranscriptForm = document.getElementById('issueTranscriptForm');
    const messageArea = document.getElementById('messageArea');
    const coursesContainer = document.getElementById('coursesContainer');
    const addCourseBtn = document.getElementById('addCourseBtn');

    const studentTranscriptListArea = document.getElementById('studentTranscriptListArea');
    const studentTranscriptDetailsArea = document.getElementById('studentTranscriptDetailsArea');
    const loadMyTranscriptsBtn = document.getElementById('loadMyTranscriptsBtn');

    const verifyTranscriptIdInput = document.getElementById('verifyTranscriptId');
    const verifyTranscriptBtn = document.getElementById('verifyTranscriptBtn');
    const verificationResultArea = document.getElementById('verificationResult');


    // --- Wallet Connection ---
    if (connectWalletBtn) {
        console.log("Connect Wallet button found in HTML. Adding listener.");
        connectWalletBtn.addEventListener('click', connectWallet);
    } else {
        console.error("Could not find element with ID 'connectWalletBtn'!");
    }

    async function connectWallet() {
        console.log("connectWallet function CALLED.");
        if (typeof window.ethereum !== 'undefined') {
            console.log("window.ethereum IS defined (MetaMask likely present).");
            try {
                console.log("Attempting: window.ethereum.request({ method: 'eth_requestAccounts' })");
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log("SUCCESS: Accounts requested (MetaMask should have shown pop-up).");

                provider = new ethers.providers.Web3Provider(window.ethereum);
                console.log("Provider created:", provider);

                signer = provider.getSigner();
                console.log("Signer object:", signer);

                if (!signer) {
                    throw new Error("Failed to get signer from provider.");
                }

                contract = new ethers.Contract(contractAddress, contractAbi, signer);
                console.log("Contract initialized:", contract);

                userAddress = await signer.getAddress();
                console.log("User address obtained:", userAddress);

                connectWalletBtn.textContent = 'Wallet Connected';
                connectWalletBtn.disabled = true;
                walletAddressSpan.textContent = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                console.log("UI Updated for connection.");

                window.ethereum.on('accountsChanged', handleAccountsChanged);

                if (document.getElementById('tab-student').classList.contains('active')) {
            // Wallet is connected, show the button and the prompt to click it
            studentTranscriptListArea.innerHTML = `
                <p class="text-gray-600">Wallet connected. Click "Load My Transcripts" to see your transcript IDs.</p>
                <button id="loadMyTranscriptsBtn" class="mt-2 px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md shadow-sm">Load My Transcripts</button>
                `;
            const newLoadBtn = document.getElementById('loadMyTranscriptsBtn');
            if (newLoadBtn) {
                newLoadBtn.addEventListener('click', loadStudentTranscripts);
            }
        }


            } catch (error) {
                console.error("Error INSIDE connectWallet try/catch:", error);
                alert("Failed to connect wallet. Please ensure MetaMask is unlocked and try again.");
                setMessage("Failed to connect wallet.", true);
            }
        } else {
            console.log("window.ethereum IS UNDEFINED (MetaMask not detected?).");
            alert('MetaMask is not installed. Please install it to use this application.');
            setMessage("MetaMask not detected.", true);
        }
        console.log("connectWallet function FINISHED.");
    }

    function handleAccountsChanged(accounts) {
        console.log("Accounts changed:", accounts);
        if (accounts.length === 0) {
            console.log('Please connect to MetaMask.');
            connectWalletBtn.textContent = 'Connect Wallet';
            connectWalletBtn.disabled = false;
            walletAddressSpan.textContent = '';
            userAddress = null;
            signer = null;
            contract = null;
            studentTranscriptListArea.innerHTML = '<p class="text-gray-600">Connect your wallet to see your transcripts.</p>';
            studentTranscriptDetailsArea.textContent = 'Select a transcript ID to view details...';
        } else {
            connectWallet();
        }
    }

    function setMessage(msg, isError = false, details = null) {
        messageArea.innerHTML = `
            <div class="${isError ? 'bg-red-100 border-red-500 text-red-700' : 'bg-green-100 border-green-500 text-green-700'} border-l-4 p-4 rounded-md">
                <p class="font-bold">${isError ? 'Error!' : 'Success!'}</p>
                <p>${msg}</p>
                ${details ? `<p class="text-xs mt-2">Details: ${details}</p>` : ''}
            </div>`;
        messageArea.style.display = 'block';
        setTimeout(() => { messageArea.style.display = 'none'; }, 10000);
    }

    const tabs = [
        { button: document.getElementById('tab-institution'), content: document.getElementById('content-institution'), id: 'tab-institution' },
        { button: document.getElementById('tab-student'), content: document.getElementById('content-student'), id: 'tab-student' },
        { button: document.getElementById('tab-employer'), content: document.getElementById('content-employer'), id: 'tab-employer' }
    ];
    tabs.forEach(tab => {
        if(tab.button) {
            tab.button.addEventListener('click', () => {
                tabs.forEach(t => {
                    if(t.content) t.content.style.display = 'none';
                    if(t.button) t.button.classList.remove('active');
                });
                if(tab.content) tab.content.style.display = 'block';
                if(tab.button) tab.button.classList.add('active');

                if (tab.id === 'tab-student') {
                    if (contract && userAddress) {
                        // Wallet is connected, show the button and the prompt to click it
                        studentTranscriptListArea.innerHTML = `
                            <p class="text-gray-600">Wallet connected. Click "Load My Transcripts" to see your transcript IDs.</p>
                            <button id="loadMyTranscriptsBtn" class="mt-2 px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md shadow-sm">Load My Transcripts</button>
                            `;
                        // Re-attach event listener if we're recreating the button
                        const newLoadBtn = document.getElementById('loadMyTranscriptsBtn');
                        if (newLoadBtn) {
                            newLoadBtn.addEventListener('click', loadStudentTranscripts);
                        }
                    } else {
                        // Wallet not connected
                        studentTranscriptListArea.innerHTML = '<p class="text-gray-600">Please connect your wallet first to see your transcripts.</p>';
                    }
                    studentTranscriptDetailsArea.textContent = 'Select a transcript ID from the list above to view details...';
                }
            });
        }
    });

    function updateRemoveButtons() {
        const removeButtons = coursesContainer.querySelectorAll('.removeCourseBtn');
        removeButtons.forEach((btn) => { btn.disabled = removeButtons.length === 1; });
    }
    if(coursesContainer) updateRemoveButtons();

    if(addCourseBtn) {
        addCourseBtn.addEventListener('click', () => {
            const newCourseRow = document.createElement('div');
            newCourseRow.classList.add('course-row');
            newCourseRow.innerHTML = `
                <input type="text" name="courseName[]" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Course Name" required>
                <input type="text" name="courseGrade[]" class="w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Grade" required>
                <button type="button" class="removeCourseBtn bg-red-500 hover:bg-red-600 text-white p-2 rounded-md shadow-sm" onclick="removeCourse(this)">
                    <i class="fas fa-trash"></i>
                </button>`;
            coursesContainer.appendChild(newCourseRow);
            updateRemoveButtons();
        });
    }

    function removeCourse(button) {
        if (coursesContainer && coursesContainer.children.length > 1) {
            button.parentElement.remove();
            updateRemoveButtons();
        }
    }

    if(issueTranscriptForm) {
        issueTranscriptForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!contract || !signer) {
                setMessage("Please connect your wallet first and ensure it's the institution's account.", true);
                return;
            }
            setMessage("Processing transaction... Please wait.", false);
            const submitButton = issueTranscriptForm.querySelector('button[type="submit"]');
            if(submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Issuing...';
            }

            try {
                const formData = new FormData(issueTranscriptForm);
                const studentName = formData.get('studentName');
                const studentId = formData.get('studentId');
                const studentEthAddress = formData.get('studentEthAddress');
                const issuingInstitution = formData.get('issuingInstitution');
                const programName = formData.get('programName');
                const courseNames = formData.getAll('courseName[]');
                const courseGrades = formData.getAll('courseGrade[]');
                const dateString = formData.get('graduationDate');
                const graduationTimestamp = Math.floor(new Date(dateString).getTime() / 1000);

                if (!ethers.utils.isAddress(studentEthAddress)) {
                    setMessage("Invalid Student Ethereum Address format.", true);
                    if(submitButton) {
                         submitButton.disabled = false;
                         submitButton.textContent = 'Issue Transcript';
                    }
                    return;
                }

                console.log("Submitting Transcript Data via Manual:", { studentName, studentId, studentEthAddress, issuingInstitution, programName, graduationTimestamp, courseNames, courseGrades });

                const tx = await contract.issueTranscriptManual(
                    studentName,
                    studentEthAddress,
                    studentId,
                    issuingInstitution,
                    programName,
                    graduationTimestamp,
                    courseNames,
                    courseGrades
                );

                setMessage("Transaction sent... Waiting for confirmation.", false, `Tx Hash: ${tx.hash}`);
                console.log("Transaction submitted:", tx.hash);

                const receipt = await tx.wait();
                console.log("Transaction confirmed:", receipt);

                let issuedTranscriptId = "N/A";
                if (receipt && receipt.events && receipt.events.length > 0) {
                    const issueEvent = receipt.events.find(e => e.event === "TranscriptIssued");
                    if (issueEvent && issueEvent.args) {
                        if (issueEvent.args.transcriptId !== undefined) {
                            issuedTranscriptId = issueEvent.args.transcriptId.toString();
                        } else { console.error("TranscriptIssued event found, but transcriptId argument is missing:", issueEvent.args); }
                    } else { console.log("TranscriptIssued event not found in receipt events, or missing args."); }
                } else { console.log("Receipt contains no events array or it is empty."); }

                setMessage(`Transcript Issued Successfully! Transcript ID: ${issuedTranscriptId}`, false, `Tx Hash: ${receipt.transactionHash}`);
                issueTranscriptForm.reset();
                coursesContainer.innerHTML = '';
                if (addCourseBtn) addCourseBtn.click();
                if (coursesContainer && coursesContainer.children.length > 0) {
                    const firstRemoveBtn = coursesContainer.children[0].querySelector('.removeCourseBtn');
                    if (firstRemoveBtn) firstRemoveBtn.disabled = true;
                }

            } catch (error) {
                console.error("Error issuing transcript:", error);
                let errorMessage = "Failed to issue transcript.";
                if (error.data?.message) { errorMessage += ` Reason: ${error.data.message}`; }
                else if (error.reason) { errorMessage += ` Reason: ${error.reason}`; }
                else if (error.message) { errorMessage += ` ${error.message}`; }
                setMessage(errorMessage, true, error.transactionHash ? `Tx Hash: ${error.transactionHash}` : null);
            } finally {
                if(submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Issue Transcript';
                }
            }
        });
    }

    // --- Student Portal Logic ---
    if (loadMyTranscriptsBtn) {
        loadMyTranscriptsBtn.addEventListener('click', loadStudentTranscripts);
    }

    async function loadStudentTranscripts() {
        if (!contract || !userAddress) {
            studentTranscriptListArea.innerHTML = '<p class="text-gray-600">Please connect your wallet to view your transcripts.</p>';
            if(loadMyTranscriptsBtn) loadMyTranscriptsBtn.disabled = true;
            return;
        }
        studentTranscriptListArea.innerHTML = '<p class="text-gray-600">Loading your transcript IDs...</p>';
        if(loadMyTranscriptsBtn) loadMyTranscriptsBtn.disabled = true;

        try {
            const ids = await contract.getMyTranscriptIds();
            if (ids.length === 0) {
                studentTranscriptListArea.innerHTML = '<p class="text-gray-600">No transcripts found for your address.</p>';
                return;
            }
            let html = '<h3 class="font-semibold mb-2">Your Transcript IDs:</h3><ul class="space-y-1">';
            ids.forEach(idBigNum => {
                const id = idBigNum.toString();
                html += `<li>Transcript ID: ${id} <button class="transcript-id-button" onclick="viewSpecificTranscript('${id}')">View Details</button></li>`;
            });
            html += "</ul>";
            studentTranscriptListArea.innerHTML = html;
        } catch (error) {
            console.error("Error fetching student transcript IDs:", error);
            studentTranscriptListArea.innerHTML = '<p class="text-red-500">Could not load your transcript IDs. Check console.</p>';
        } finally {
             if(loadMyTranscriptsBtn && contract && userAddress) loadMyTranscriptsBtn.disabled = false;
        }
    }

    // Make this function globally accessible for the inline onclick
    window.viewSpecificTranscript = async function(transcriptId) {
        if (!contract) {
            studentTranscriptDetailsArea.textContent = 'Please connect your wallet first.';
            return;
        }
        console.log(`Attempting to view transcript ID: ${transcriptId}`);
        studentTranscriptDetailsArea.textContent = `Workspaceing details for Transcript ID: ${transcriptId}...`;
        try {
            const readOnlyContract = contract.connect(provider);
            const transcript = await readOnlyContract.getTranscript(transcriptId);

            if (!transcript || transcript.issuerAddress === ethers.constants.AddressZero || transcript.id.toString() !== transcriptId) {
                studentTranscriptDetailsArea.textContent = `Transcript ID: ${transcriptId} not found or invalid data.`;
                return;
            }

            let coursesHtml = transcript.courses.map(c => `<li>${c.name}: ${c.grade}</li>`).join('');
            const gradDate = new Date(transcript.graduationDate.toNumber() * 1000).toLocaleDateString();
            const issueDate = new Date(transcript.issueTimestamp.toNumber() * 1000).toLocaleString();

            studentTranscriptDetailsArea.innerHTML = `
                 <h3 class="font-semibold text-lg mb-2">Transcript ID: ${transcript.id.toString()}</h3>
                 <p><strong>Student Name:</strong> ${transcript.studentName}</p>
                 <p><strong>Student Ethereum Address:</strong> ${transcript.studentAddress}</p>
                 <p><strong>Student ID (Institution):</strong> ${transcript.studentId}</p>
                 <p><strong>Institution:</strong> ${transcript.issuingInstitution}</p>
                 <p><strong>Program:</strong> ${transcript.programName}</p>
                 <p><strong>Graduation Date:</strong> ${gradDate}</p>
                 <p><strong>Issued By (Institution Address):</strong> ${transcript.issuerAddress}</p>
                 <p><strong>Issued On:</strong> ${issueDate}</p>
                 <h4 class="font-semibold mt-3 mb-1">Courses:</h4>
                 <ul class="list-disc list-inside pl-4">${coursesHtml}</ul>`;
        } catch (error) {
            console.error("Error fetching transcript details for ID " + transcriptId + ":", error);
            studentTranscriptDetailsArea.textContent = `Error fetching transcript ID ${transcriptId}. Check console.`;
            if (error.data?.message) { studentTranscriptDetailsArea.textContent += ` Reason: ${error.data.message}`; }
            else if (error.reason) { studentTranscriptDetailsArea.textContent += ` Reason: ${error.reason}`; }
        }
    }

    // --- Employer Portal: Verify Transcript ---
    if(verifyTranscriptBtn) {
        verifyTranscriptBtn.addEventListener('click', async () => {
            const transcriptId = verifyTranscriptIdInput.value;
            if (!transcriptId) {
                verificationResultArea.textContent = 'Please enter a Transcript ID to verify.';
                return;
            }
            if (!provider) {
                alert("Blockchain provider not available. Please connect your wallet if it's not connected, or refresh if it is.");
                return;
            }
            const readOnlyContract = new ethers.Contract(contractAddress, contractAbi, provider);
            verificationResultArea.textContent = `Verifying Transcript ID: ${transcriptId}...`;
            try {
                const transcript = await readOnlyContract.getTranscript(transcriptId);
                if (transcript && transcript.issuerAddress !== ethers.constants.AddressZero && transcript.id.toString() === transcriptId) {
                    verificationResultArea.innerHTML = `<p class="text-green-600 font-semibold">Transcript ID: ${transcriptId} is VERIFIED.</p><p class="text-xs">Issued by: ${transcript.issuingInstitution} on ${new Date(transcript.issueTimestamp.toNumber() * 1000).toLocaleDateString()}</p>`;
                } else {
                    verificationResultArea.innerHTML = `<p class="text-red-600 font-semibold">Transcript ID: ${transcriptId} NOT FOUND or Invalid Data.</p>`;
                }
            } catch (error) {
                console.error("Error verifying transcript:", error);
                verificationResultArea.innerHTML = `<p class="text-red-600 font-semibold">Transcript ID: ${transcriptId} is INVALID or NOT FOUND. Check console.</p>`;
                if (error.data?.message) { verificationResultArea.innerHTML += ` Reason: ${error.data.message}`; }
                else if (error.reason) { verificationResultArea.innerHTML += ` Reason: ${error.reason}`; }
            }
        });
    }

    // --- Footer Year ---
    document.getElementById('currentYear').textContent = new Date().getFullYear();

</script>
</body>
</html>